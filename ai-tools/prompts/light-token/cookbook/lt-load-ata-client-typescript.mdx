~~~~text
---
argument-hint: <project_path>
description: Load token balances from multiple sources to a unified light ATA in TypeScript
allowed-tools: [Bash, Read, Glob, Grep, Task, mcp__deepwiki, mcp__zkcompression]
---

## Task: Load token balances to light ATA (TypeScript)

References:
- Cookbook Guide: https://zkcompression.com/light-token/cookbook/load-ata
- SDK Reference: https://lightprotocol.github.io/light-protocol/compressed-token/index.html
- GitHub Example: https://github.com/Lightprotocol/examples-light-token

MCP:
* deepwiki https://mcp.deepwiki.com/mcp
* zkcompression https://www.zkcompression.com/mcp

## Workflow

- This plan must execute without user intervention
- All questions have been resolved in planning phase
- If blocked, find alternative approach - do not stop
- Keep working until ALL todos are complete
- Use Task tool with subagents for parallel research or when stuck
- Use subagents with Read, Glob, Grep, and Deepwiki permissions when stuck
- Always assign Tasks to subagents and tell the user

## DeepWiki fallback

```
mcp__deepwiki__read_wiki_structure("Lightprotocol/light-protocol"),
mcp__deepwiki__read_wiki_contents("Lightprotocol/light-protocol"),
mcp__deepwiki__ask_question("Lightprotocol/light-protocol", "<question>")
```

## Quick Reference

| Operation | Function | Purpose |
|-----------|----------|---------|
| Connect | createRpc() | Connect to ZK Compression RPC endpoint |
| Load Tokens (Action) | loadAta() | High-level action that loads all token sources to ATA and returns signature |
| Load Tokens (Instruction) | createLoadAtaInstructions() | Build instructions for manual transaction construction |
| Get ATA Address | getAssociatedTokenAddressInterface() | Derive light ATA address from mint and owner |
| Fetch Balances | getAtaInterface() | Get unified view of all token balances across sources |
| Send Transaction | sendAndConfirmTx() | Submit transaction to network |

### Phase 1: Index project

```bash
grep -r "createRpc\|@lightprotocol/compressed-token\|@solana/web3.js" src/
```

### Phase 2: Add dependencies

```bash
npm install --save \
    @lightprotocol/compressed-token@0.22.1-alpha.1 \
    @lightprotocol/stateless.js@0.22.1-alpha.1 \
    @solana/web3.js
```

### Phase 3: Implement load ATA

See Code Reference below for TypeScript implementation.

**Two Approaches:**

1. **Action (Recommended)**: Use `loadAta()` for simple, automatic loading
   - Automatically handles balance checks, instruction creation, and transaction submission
   - Returns transaction signature or null if nothing to load (idempotent)
   - Example: Action code below

2. **Instruction (Advanced)**: Use `createLoadAtaInstructions()` for manual transaction control
   - Gives full control over transaction construction
   - Returns empty array if nothing to load
   - Useful for batching multiple instructions
   - Example: Instruction code below

#### Action Approach

1. **RPC Setup**: Connect to ZK Compression RPC endpoint (Helius, Triton, or localnet)
   - Use `createRpc()` with mainnet, devnet, or local URLs
   - For devnet: `https://devnet.helius-rpc.com?api-key=${API_KEY}`
   - For localnet: `createRpc()` with no arguments

2. **Setup Test Tokens**: Create mint and mint tokens to compressed state (cold storage)
   - Use `createMint()` to create a test mint
   - Use `mintTo()` to mint tokens directly to compressed state
   - Tokens start in "cold" state (compressed, rent-free)

3. **Derive ATA Address**: Calculate light ATA address for the mint and owner
   - Use `getAssociatedTokenAddressInterface(mint, owner)` helper
   - Returns light ATA address regardless of whether it exists yet

4. **Load Tokens**: Call `loadAta()` to unify all token sources into the light ATA
   - Parameters: `(rpc, lightAta, owner, mint, payer?)`
   - Automatically creates the ATA if it doesn't exist
   - Loads compressed tokens (cold) by decompressing them to hot state
   - Returns transaction signature or null if nothing to load
   - Idempotent: safe to call multiple times

#### Instruction Approach

1. **RPC Setup**: Same as Action approach

2. **Setup Test Tokens**: Same as Action approach

3. **Derive ATA Address**: Same as Action approach

4. **Create Instructions**: Build load instructions with manual transaction control
   - Call `createLoadAtaInstructions(rpc, lightAta, owner, mint, payer?)`
   - Returns array of instructions (empty if nothing to load)
   - Check array length before proceeding

5. **Build Transaction**: Construct transaction from instructions
   - Fetch latest blockhash with `rpc.getLatestBlockhash()`
   - Use `buildAndSignTx(ixs, payer, blockhash)` to build and sign
   - Sign with payer keypair

6. **Send Transaction**: Submit transaction to network
   - Use `sendAndConfirmTx(rpc, tx)` to send and wait for confirmation

### Phase 4: Test

Run the client code. On failure, debug and retry. Assign debugging to subagents with Task tool.

For localnet testing:
```bash
light test-validator
```

For devnet/mainnet, ensure RPC endpoint supports ZK Compression (Helius, Triton).

## Code Reference

### Action Approach (Recommended)

```typescript
import "dotenv/config";
import { Keypair } from "@solana/web3.js";
import { createRpc, bn } from "@lightprotocol/stateless.js";
import {
    createMint,
    mintTo,
    loadAta,
    getAssociatedTokenAddressInterface,
} from "@lightprotocol/compressed-token";
import { homedir } from "os";
import { readFileSync } from "fs";

// devnet:
const RPC_URL = `https://devnet.helius-rpc.com?api-key=${process.env.API_KEY!}`;
// localnet:
// const RPC_URL = undefined;
const payer = Keypair.fromSecretKey(
    new Uint8Array(
        JSON.parse(readFileSync(`${homedir()}/.config/solana/id.json`, "utf8"))
    )
);

(async function () {
    // devnet:
    const rpc = createRpc(RPC_URL);
    // localnet:
    // const rpc = createRpc();

    // Setup: Get compressed tokens (cold storage)
    const { mint } = await createMint(rpc, payer, payer.publicKey, 9);
    await mintTo(rpc, payer, mint, payer.publicKey, payer, bn(1000));

    // Load compressed tokens to hot balance
    const lightTokenAta = getAssociatedTokenAddressInterface(mint, payer.publicKey);
    const tx = await loadAta(rpc, lightTokenAta, payer, mint, payer);

    console.log("Tx:", tx);
})();
```

### Instruction Approach (Advanced)

```typescript
import "dotenv/config";
import { Keypair } from "@solana/web3.js";
import {
    createRpc,
    bn,
    buildAndSignTx,
    sendAndConfirmTx,
} from "@lightprotocol/stateless.js";
import {
    createMint,
    mintTo,
    createLoadAtaInstructions,
    getAssociatedTokenAddressInterface,
} from "@lightprotocol/compressed-token";
import { homedir } from "os";
import { readFileSync } from "fs";

// devnet:
const RPC_URL = `https://devnet.helius-rpc.com?api-key=${process.env.API_KEY!}`;
const rpc = createRpc(RPC_URL);
// localnet:
// const rpc = createRpc();

const payer = Keypair.fromSecretKey(
    new Uint8Array(
        JSON.parse(readFileSync(`${homedir()}/.config/solana/id.json`, "utf8"))
    )
);

(async function () {
    // Setup: mint directly to cold state
    const { mint } = await createMint(rpc, payer, payer.publicKey, 9);
    await mintTo(rpc, payer, mint, payer.publicKey, payer, bn(1000));

    const lightTokenAta = getAssociatedTokenAddressInterface(mint, payer.publicKey);

    // load from cold to hot state
    const ixs = await createLoadAtaInstructions(
        rpc,
        lightTokenAta,
        payer.publicKey,
        mint,
        payer.publicKey
    );

    if (ixs.length === 0) return console.log("Nothing to load");

    const blockhash = await rpc.getLatestBlockhash();
    const tx = buildAndSignTx(ixs, payer, blockhash.blockhash);
    const signature = await sendAndConfirmTx(rpc, tx);
    console.log("Tx:", signature);
})();
```

### Key Differences

| Aspect | Action Approach | Instruction Approach |
|--------|----------------|---------------------|
| Complexity | Simple, one function call | More setup required |
| Control | Automatic | Full manual control |
| Use Case | Most common scenarios | Batching, custom flows |
| ATA Creation | Auto-created if needed | Auto-created if needed |
| Balance Check | Auto-checked | Must check ixs.length |
| Transaction | Auto-built and sent | Must build and send |
| Return Value | Signature or null | Instructions array |

### What loadAta Does

`loadAta()` unifies token balances from multiple sources into a single light ATA:

1. **Compressed tokens (cold)**: Decompresses to light ATA hot balance
2. **SPL balance** (if `wrap=true`): Wraps to light ATA
3. **Token-2022 balance** (if `wrap=true`): Wraps to light ATA

**Default behavior** (`wrap=false`):
- Only loads compressed tokens (cold) to hot balance
- Does not touch SPL or Token-2022 balances

**Unified mode** (`wrap=true`):
- Loads compressed tokens AND wraps SPL/T22 balances
- Creates a unified view across all token programs
- Target ATA must be a c-token ATA (light ATA)

### Token State: Cold vs Hot

Light tokens have two states:

- **Cold (compressed)**: Rent-free, stored in Merkle trees, requires ZK proofs to modify
- **Hot (uncompressed)**: Standard ATA, pays rent, fast operations, no proofs needed

`loadAta()` moves tokens from cold to hot state, making them available in the light ATA for immediate use.

### Important Notes

1. **Idempotent**: `loadAta()` returns `null` if there's nothing to load. Safe to call multiple times.

2. **Automatic ATA Creation**: Both approaches create the light ATA if it doesn't exist. No need to call `createAtaInterface()` first.

3. **Light ATA Address**: Use `getAssociatedTokenAddressInterface(mint, owner)` to derive the light ATA address. This is different from SPL's `getAssociatedTokenAddressSync()`.

4. **Network Selection**:
   - Devnet: Use Helius RPC with API key
   - Localnet: Use `createRpc()` with no arguments (requires `light test-validator`)

5. **Wrap Parameter**: By default, `loadAta()` only loads compressed tokens. Set `wrap=true` to also wrap SPL/T22 balances into the light ATA.

6. **Return Values**:
   - Action: Returns transaction signature or `null` (nothing to load)
   - Instruction: Returns instructions array (empty if nothing to load)

~~~~
