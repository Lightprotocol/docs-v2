---
argument-hint: <project_path>
description: Create associated light-token account with TypeScript client
allowed-tools: [Bash, Read, Glob, Grep, Task, mcp__deepwiki, mcp__zkcompression]
---

## Task: Create associated light-token account (TypeScript)

References:
- Client Guide: https://zkcompression.com/light-token/cookbook/create-ata
- SDK Reference: https://lightprotocol.github.io/light-protocol/compressed-token/index.html
- GitHub Example: https://github.com/Lightprotocol/examples-light-token

MCP:
* deepwiki https://mcp.deepwiki.com/mcp
* zkcompression https://www.zkcompression.com/mcp

## Workflow

- This plan must execute without user intervention
- All questions have been resolved in planning phase
- If blocked, find alternative approach - do not stop
- Keep working until ALL todos are complete
- Use Task tool with subagents for parallel research or when stuck
- Use subagents with Read, Glob, Grep, and Deepwiki permissions when stuck
- Always assign Tasks to subagents and tell the user

## DeepWiki fallback

```
mcp__deepwiki__read_wiki_structure("Lightprotocol/light-protocol"),
mcp__deepwiki__read_wiki_contents("Lightprotocol/light-protocol"),
mcp__deepwiki__ask_question("Lightprotocol/light-protocol", "<question>")
```

## Quick Reference

| Operation | Function | Purpose |
|-----------|----------|---------|
| Connect | createRpc() | Connect to ZK Compression RPC endpoint |
| Derive Address | getAssociatedTokenAddressInterface() | Derive deterministic ATA address from mint and owner |
| Create ATA (Action) | createAtaInterface() | Create ATA in single call (handles instruction + transaction) |
| Build Instruction | createAssociatedTokenAccountInterfaceInstruction() | Build instruction to create ATA |
| Send Transaction | sendAndConfirmTransaction() | Submit transaction to network |

### Phase 1: Index project

```bash
grep -r "createRpc\|Connection\|@solana/web3.js" src/
```

### Phase 2: Add dependencies

```bash
npm install --save \
    @lightprotocol/compressed-token@0.22.1-alpha.2 \
    @lightprotocol/stateless.js@0.22.1-alpha.1 \
    @solana/web3.js
```

### Phase 3: Implement client operations

See Code Reference below for TypeScript implementation.

1. **RPC Setup**: Connect to ZK Compression RPC endpoint (Helius, Triton, or localnet)
   - Use `createRpc()` with mainnet, devnet, or local URLs
   - Requires ZK Compression RPC endpoint with Helius or Triton API key for devnet/mainnet
   - Example: https://github.com/Lightprotocol/light-protocol/blob/main/js/compressed-token/src/v3/actions/create-ata-interface.ts#L43-L53

2. **Derive ATA Address**: Generate deterministic address for associated token account
   - Use `getAssociatedTokenAddressInterface()` with mint and owner pubkeys
   - Address is derived from `[owner, CTOKEN_PROGRAM_ID, mint]`
   - Optional: Set `allowOwnerOffCurve = true` to allow PDA owners
   - Example: https://github.com/Lightprotocol/light-protocol/blob/main/js/compressed-token/src/v3/actions/create-ata-interface.ts#L57-L63

3. **Create ATA (Method 1: Action)**
   - Use `createAtaInterface()` for one-call creation (handles instruction building and transaction submission)
   - Pass RPC, payer signer, mint pubkey, and owner pubkey
   - Automatically sets compute budget (30,000 units for c-token)
   - Returns ATA address after successful creation
   - Example: https://github.com/Lightprotocol/light-protocol/blob/main/js/compressed-token/src/v3/actions/create-ata-interface.ts#L43-L95

4. **Create ATA (Method 2: Instruction)**
   - Build instruction with `createAssociatedTokenAccountInterfaceInstruction()`
   - Requires: payer pubkey, ATA address, owner pubkey, mint pubkey
   - Optional: Specify `programId` (defaults to CTOKEN_PROGRAM_ID) and `ctokenConfig` for custom rent configuration
   - Add instruction to transaction and send with `sendAndConfirmTransaction()`
   - Example: https://github.com/Lightprotocol/light-protocol/blob/main/js/compressed-token/src/v3/instructions/create-ata-interface.ts#L50-L81

5. **Rent Configuration** (Optional)
   - Associated light-token accounts use default rent config:
     - Initial: ~17,208 lamports for 24h rent + compression incentive
     - Maintenance: Auto top-up of 776 lamports when rent drops below 3h
   - Custom config via `ctokenConfig` parameter with `compressibleConfig`, `configAccount`, and `rentPayerPda`

### Phase 4: Test

Run the client code. On failure, debug and retry. Assign debugging to subagents with Task tool.

For localnet testing:
```bash
light test-validator
```

For devnet/mainnet, ensure RPC endpoint supports ZK Compression (Helius, Triton).

## Code Reference

### Method 1: Using Action (createAtaInterface)

```typescript
import "dotenv/config";
import { Keypair } from "@solana/web3.js";
import { createRpc } from "@lightprotocol/stateless.js";
import {
    createMintInterface,
    createAtaInterface,
} from "@lightprotocol/compressed-token";
import { homedir } from "os";
import { readFileSync } from "fs";

// devnet:
const RPC_URL = `https://devnet.helius-rpc.com?api-key=${process.env.API_KEY!}`;
// localnet:
// const RPC_URL = undefined;
const payer = Keypair.fromSecretKey(
    new Uint8Array(
        JSON.parse(readFileSync(`${homedir()}/.config/solana/id.json`, "utf8"))
    )
);

(async function () {
    // devnet:
    const rpc = createRpc(RPC_URL);
    // localnet:
    // const rpc = createRpc();

    // Create a mint first (or use existing mint)
    const { mint } = await createMintInterface(rpc, payer, payer, null, 9);

    // Define owner (can be different from payer)
    const owner = Keypair.generate();

    // Create ATA - single call handles everything
    const ata = await createAtaInterface(rpc, payer, mint, owner.publicKey);

    console.log("ATA:", ata.toBase58());
})();
```

### Method 2: Using Instruction (Manual Transaction Building)

```typescript
import "dotenv/config";
import {
    Keypair,
    Transaction,
    sendAndConfirmTransaction,
} from "@solana/web3.js";
import { createRpc, CTOKEN_PROGRAM_ID } from "@lightprotocol/stateless.js";
import {
    createMintInterface,
    createAssociatedTokenAccountInterfaceInstruction,
    getAssociatedTokenAddressInterface,
} from "@lightprotocol/compressed-token";
import { homedir } from "os";
import { readFileSync } from "fs";

// devnet:
const RPC_URL = `https://devnet.helius-rpc.com?api-key=${process.env.API_KEY!}`;
const rpc = createRpc(RPC_URL);
// localnet:
// const rpc = createRpc();

const payer = Keypair.fromSecretKey(
    new Uint8Array(
        JSON.parse(readFileSync(`${homedir()}/.config/solana/id.json`, "utf8"))
    )
);

(async function () {
    // Create a mint first (or use existing mint)
    const { mint } = await createMintInterface(rpc, payer, payer, null, 9);

    // Define owner (can be different from payer)
    const owner = Keypair.generate();

    // Derive deterministic ATA address
    const associatedToken = getAssociatedTokenAddressInterface(
        mint,
        owner.publicKey
    );

    // Build instruction to create ATA
    const ix = createAssociatedTokenAccountInterfaceInstruction(
        payer.publicKey,
        associatedToken,
        owner.publicKey,
        mint,
        CTOKEN_PROGRAM_ID
    );

    // Create and send transaction
    const tx = new Transaction().add(ix);
    const signature = await sendAndConfirmTransaction(rpc, tx, [payer]);

    console.log("ATA:", associatedToken.toBase58());
    console.log("Tx:", signature);
})();
```

### Method 3: Idempotent ATA Creation

```typescript
import "dotenv/config";
import { Keypair } from "@solana/web3.js";
import { createRpc } from "@lightprotocol/stateless.js";
import {
    createMintInterface,
    createAtaInterfaceIdempotent,
} from "@lightprotocol/compressed-token";
import { homedir } from "os";
import { readFileSync } from "fs";

const RPC_URL = `https://devnet.helius-rpc.com?api-key=${process.env.API_KEY!}`;
const payer = Keypair.fromSecretKey(
    new Uint8Array(
        JSON.parse(readFileSync(`${homedir()}/.config/solana/id.json`, "utf8"))
    )
);

(async function () {
    const rpc = createRpc(RPC_URL);

    // Create a mint first (or use existing mint)
    const { mint } = await createMintInterface(rpc, payer, payer, null, 9);

    const owner = Keypair.generate();

    // Create ATA idempotently - succeeds even if account exists
    const ata = await createAtaInterfaceIdempotent(
        rpc,
        payer,
        mint,
        owner.publicKey
    );

    console.log("ATA:", ata.toBase58());
})();
```

### Rent Configuration Details

Associated light-token accounts implement a default rent config:

1. **At account creation**:
   - Pay ~17,208 lamports for 24h of rent (16 epochs @ 1.5h each)
   - Includes compression incentive (10,000 for transaction cost + 1,000 protocol incentive)
   - Rent-exemption is sponsored by the protocol

2. **During transfers**:
   - Accounts are kept funded with rent for 3h via automatic top-ups
   - Transaction payer tops up 776 lamports when account rent is below 3h

**Custom Rent Config** (optional):

```typescript
import { createAtaInterface } from "@lightprotocol/compressed-token";
import { CTOKEN_PROGRAM_ID } from "@lightprotocol/stateless.js";

// Define custom rent config
const ctokenConfig = {
    compressibleConfig: {
        prePayNumEpochs: 16,  // 24 hours
        lamportsPerWrite: 1077,  // Per-write cost
    },
    configAccount: configAccountPubkey,  // Config account address
    rentPayerPda: rentPayerPdaPubkey,    // PDA that pays rent-exemption
};

// Create ATA with custom config
const ata = await createAtaInterface(
    rpc,
    payer,
    mint,
    owner.publicKey,
    false,  // allowOwnerOffCurve
    undefined,  // confirmOptions
    CTOKEN_PROGRAM_ID,
    undefined,  // associatedTokenProgramId
    ctokenConfig
);
```

### For SPL or Token-2022 Mints

The same functions work for SPL Token and Token-2022 mints. Simply pass the corresponding program ID:

```typescript
import { TOKEN_PROGRAM_ID, TOKEN_2022_PROGRAM_ID } from "@solana/spl-token";
import {
    createAtaInterface,
    getAssociatedTokenAddressInterface,
} from "@lightprotocol/compressed-token";

// For SPL Token
const splAta = await createAtaInterface(
    rpc,
    payer,
    splMint,
    owner.publicKey,
    false,
    undefined,
    TOKEN_PROGRAM_ID
);

// For Token-2022
const token2022Ata = await createAtaInterface(
    rpc,
    payer,
    token2022Mint,
    owner.publicKey,
    false,
    undefined,
    TOKEN_2022_PROGRAM_ID
);
```
