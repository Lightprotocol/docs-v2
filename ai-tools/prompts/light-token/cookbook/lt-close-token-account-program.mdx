---
argument-hint: <project_path>
description: Close light-token account using Anchor framework
allowed-tools: [Bash, Read, Glob, Grep, Task, mcp__deepwiki, mcp__zkcompression]
---

## Task: Close light-token account via CPI

Close light-token accounts and transfer remaining lamports to a destination account using CPI to the Light Token Program.

References:
- Guide: https://zkcompression.com/light-token/cookbook/close-token-account
- SDK Reference: https://docs.rs/light-token/latest/light_token/
- GitHub Example: https://github.com/Lightprotocol/light-protocol/blob/main/sdk-tests/sdk-light-token-test/src/close.rs

MCP:
* deepwiki https://mcp.deepwiki.com/mcp
* zkcompression https://www.zkcompression.com/mcp

## Workflow

- This plan must execute without user intervention
- All questions have been resolved in planning phase
- If blocked, find alternative approach - do not stop
- Keep working until ALL todos are complete
- Use Task tool with subagents for parallel research or when stuck
- Use subagents with Read, Glob, Grep, and Deepwiki permissions when stuck
- Always assign Tasks to subagents and tell the user

## DeepWiki fallback

```
mcp__deepwiki__read_wiki_structure("Lightprotocol/light-protocol"),
mcp__deepwiki__read_wiki_contents("Lightprotocol/light-protocol"),
mcp__deepwiki__ask_question("Lightprotocol/light-protocol", "<question>")
```

## Quick Reference

| Operation | SPL Token Account | Light-Token Account |
| --------- | ----------------- | ------------------- |
| Close Account | `close_account()` | CPI to Light Token Program |
| Rent Reclaim | Rent goes to destination | Lamports go to destination, rent sponsor can reclaim sponsored rent |
| Reopen Account | Cannot reopen | Can be reinstated (decompressed) when closed by compression_authority |
| Zero Balance | Required | Required |
| Authority | Account owner or close_authority | Account owner only |

### Phase 1: Index project

```bash
find . -name "Cargo.toml" -o -name "lib.rs" -o -name "Anchor.toml"
```

### Phase 2: Add dependencies

Add to `programs/[name]/Cargo.toml`:

```toml
[dependencies]
light-token = "0.7.0"
anchor_lang = "0.31.1"
solana-program = "2.1.6"
```

### Phase 3: Implement program

See Code Reference below. Implementation follows these steps:

1. **Validate Accounts**: Ensure minimum 5 accounts provided (token_program, account, destination, owner, rent_sponsor)
   - Source: https://github.com/Lightprotocol/light-protocol/blob/main/sdk-tests/sdk-light-token-test/src/close.rs#L15-L17
2. **Build CPI Struct**: Create `CloseAccountCpi` with required accounts
   - Source: https://github.com/Lightprotocol/light-protocol/blob/main/sdk-tests/sdk-light-token-test/src/close.rs#L19-L25
3. **CPI to Light Token Program**: Use `.invoke()` or `.invoke_signed()` based on owner type
   - invoke: When owner is external keypair
   - invoke_signed: When owner is PDA (requires seeds)
   - Source: https://github.com/Lightprotocol/light-protocol/blob/main/sdk-tests/sdk-light-token-test/src/close.rs#L26

### Phase 4: Test

Build and test the program:

```bash
anchor build && anchor test
```

On failure, debug and retry. Assign always to subagents with Task tool.

## Code Reference

### Account Validation

```rust
use light_token::instruction::CloseAccountCpi;
use solana_program::{account_info::AccountInfo, program_error::ProgramError, pubkey::Pubkey};

pub fn process_close_account(accounts: &[AccountInfo]) -> Result<(), ProgramError> {
    if accounts.len() < 5 {
        return Err(ProgramError::NotEnoughAccountKeys);
    }

    // Account validation complete - proceed to CPI
}
```

**Note**: The minimum account count is 5. All accounts are required for closing a light-token account.

### CPI Variants

#### invoke (External Keypair Owner)

```rust
use light_token::instruction::CloseAccountCpi;

CloseAccountCpi {
    token_program: accounts[0].clone(),
    account: accounts[1].clone(),
    destination: accounts[2].clone(),
    owner: accounts[3].clone(),
    rent_sponsor: accounts[4].clone(),
}
.invoke()?;
```

#### invoke_signed (PDA Owner)

```rust
use light_token::instruction::CloseAccountCpi;
use solana_program::pubkey::Pubkey;

use crate::{ID, TOKEN_ACCOUNT_SEED};

// Derive the PDA for the authority
let (pda, bump) = Pubkey::find_program_address(&[TOKEN_ACCOUNT_SEED], &ID);

// Verify the authority account is the PDA we expect
if &pda != accounts[3].key {
    return Err(ProgramError::InvalidSeeds);
}

let signer_seeds: &[&[u8]] = &[TOKEN_ACCOUNT_SEED, &[bump]];
CloseAccountCpi {
    token_program: accounts[0].clone(),
    account: accounts[1].clone(),
    destination: accounts[2].clone(),
    owner: accounts[3].clone(),
    rent_sponsor: accounts[4].clone(),
}
.invoke_signed(&[signer_seeds])?;
```

### Full Program Example

```rust
use light_token::instruction::CloseAccountCpi;
use solana_program::{account_info::AccountInfo, program_error::ProgramError, pubkey::Pubkey};

use crate::{ID, TOKEN_ACCOUNT_SEED};

/// Handler for closing a compressed token account (invoke)
///
/// Account order:
/// - accounts[0]: token_program (ctoken program)
/// - accounts[1]: account to close (writable)
/// - accounts[2]: destination for lamports (writable)
/// - accounts[3]: owner/authority (signer)
/// - accounts[4]: rent_sponsor (writable)
pub fn process_close_account_invoke(accounts: &[AccountInfo]) -> Result<(), ProgramError> {
    if accounts.len() < 5 {
        return Err(ProgramError::NotEnoughAccountKeys);
    }

    CloseAccountCpi {
        token_program: accounts[0].clone(),
        account: accounts[1].clone(),
        destination: accounts[2].clone(),
        owner: accounts[3].clone(),
        rent_sponsor: accounts[4].clone(),
    }
    .invoke()?;

    Ok(())
}

/// Handler for closing a PDA-owned compressed token account (invoke_signed)
///
/// Account order:
/// - accounts[0]: token_program (ctoken program)
/// - accounts[1]: account to close (writable)
/// - accounts[2]: destination for lamports (writable)
/// - accounts[3]: PDA owner/authority (not signer, program signs)
/// - accounts[4]: rent_sponsor (writable)
pub fn process_close_account_invoke_signed(accounts: &[AccountInfo]) -> Result<(), ProgramError> {
    if accounts.len() < 5 {
        return Err(ProgramError::NotEnoughAccountKeys);
    }

    // Derive the PDA for the authority
    let (pda, bump) = Pubkey::find_program_address(&[TOKEN_ACCOUNT_SEED], &ID);

    // Verify the authority account is the PDA we expect
    if &pda != accounts[3].key {
        return Err(ProgramError::InvalidSeeds);
    }

    let signer_seeds: &[&[u8]] = &[TOKEN_ACCOUNT_SEED, &[bump]];
    CloseAccountCpi {
        token_program: accounts[0].clone(),
        account: accounts[1].clone(),
        destination: accounts[2].clone(),
        owner: accounts[3].clone(),
        rent_sponsor: accounts[4].clone(),
    }
    .invoke_signed(&[signer_seeds])?;

    Ok(())
}
```

## Key Concepts

### Light-Token Account Close vs SPL Close

**SPL Token Account:**
- Rent-exempt lamports returned to destination
- Account permanently destroyed
- Cannot be reopened after closing

**Light-Token Account:**
- Remaining lamports transferred to destination
- Rent sponsor can reclaim sponsored rent
- Can be closed by owner at any time
- Can be closed by compression_authority when compressible
- When closed by compression_authority, account is compressed and can be reinstated (decompressed)

### Core Components

1. **CloseAccountCpi**: Builder pattern for CPI
   - `token_program`: Light Token Program
   - `account`: Token account to close
   - `destination`: Receives remaining lamports
   - `owner`: Account owner (must sign)
   - `rent_sponsor`: Receives reclaimed rent
   - `.invoke()`: For external keypair owners
   - `.invoke_signed()`: For PDA owners

2. **Account Requirements**:
   - Account balance must be 0
   - Owner must sign (external keypair) or program must sign (PDA)
   - Destination receives remaining lamports
   - Rent sponsor receives reclaimed rent

3. **Close Authority Types**:
   - Owner: Can close account at any time
   - Compression Authority: Can close account when compressible (rent for less than 1 epoch)

### Security

- **Authority validation**: Owner must be valid signer
- **PDA verification**: When using PDAs, verify derived address matches expected
- **Balance check**: Account balance must be 0 before closing
- **Account ownership**: Ensure account is owned by Light Token Program

### Common Errors

| Error | Cause | Solution |
|-------|-------|----------|
| `ProgramError::InvalidSeeds` | PDA derivation mismatch | Verify PDA seeds match expected derivation |
| `ProgramError::NotEnoughAccountKeys` | Missing required accounts | Check all 5 accounts are provided |
| `ProgramError::InvalidAccountData` | Non-zero balance | Ensure account balance is 0 before closing |
| Owner not signer | Owner must sign close instruction | Ensure owner is marked as signer |
