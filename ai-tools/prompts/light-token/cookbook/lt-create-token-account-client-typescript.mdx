~~~~text
---
argument-hint: <project_path>
description: Create compressed token account client implementation in TypeScript
allowed-tools: [Bash, Read, Glob, Grep, Task, mcp__deepwiki, mcp__zkcompression]
---

## Task: Create compressed token account (TypeScript)

References:
- Client Guide: https://zkcompression.com/light-token/cookbook/create-token-account
- SDK Reference: https://lightprotocol.github.io/light-protocol/compressed-token/index.html
- GitHub Example: https://github.com/Lightprotocol/examples-light-token

MCP:
* deepwiki https://mcp.deepwiki.com/mcp
* zkcompression https://www.zkcompression.com/mcp

## Workflow

- This plan must execute without user intervention
- All questions have been resolved in planning phase
- If blocked, find alternative approach - do not stop
- Keep working until ALL todos are complete
- Use Task tool with subagents for parallel research or when stuck
- Use subagents with Read, Glob, Grep, and Deepwiki permissions when stuck
- Always assign Tasks to subagents and tell the user

## DeepWiki fallback

```
mcp__deepwiki__read_wiki_structure("Lightprotocol/light-protocol"),
mcp__deepwiki__read_wiki_contents("Lightprotocol/light-protocol"),
mcp__deepwiki__ask_question("Lightprotocol/light-protocol", "<question>")
```

## Quick Reference

| Operation | Function | Purpose |
|-----------|----------|---------|
| Connect | createRpc() | Connect to ZK Compression RPC endpoint |
| Derive ATA | getAssociatedTokenAddressInterface() | Derive associated token account address |
| Build Instruction | createAtaInterfaceIdempotentInstruction() | Build instruction to create token account |
| Send Transaction | buildAndSignTx() + sendAndConfirmTx() | Submit transaction to network |
| Verify Account | getAccountInterface() | Fetch and verify token account data |

### Phase 1: Index project

```bash
grep -r "createRpc\|@lightprotocol/compressed-token\|@solana/web3.js" src/
```

### Phase 2: Add dependencies

```bash
npm install --save \
    @lightprotocol/compressed-token@latest \
    @lightprotocol/stateless.js@latest \
    @solana/web3.js
```

### Phase 3: Implement client operations

See Code Reference below for TypeScript implementation.

1. **RPC Setup**: Connect to ZK Compression RPC endpoint (Helius, Triton, or localnet)
   - Use `createRpc()` with mainnet, devnet, or local URLs
   - For devnet: `https://devnet.helius-rpc.com?api-key=<YOUR_API_KEY>`
   - For local: `http://127.0.0.1:8899`
   - Example: Create RPC connection with appropriate endpoint

2. **Create Mint**: Prerequisite - compressed token accounts require a compressed mint
   - Use `createMintInterface()` to create a compressed mint
   - Specify decimals (commonly 9 for tokens)
   - Save mint address for token account creation
   - Example: `const mintAddress = await createMintInterface(rpc, payer, payer.publicKey, 9)`

3. **Derive ATA Address**: Generate associated token account address
   - Use `getAssociatedTokenAddressInterface()` with mint and owner
   - Returns deterministic PDA: hash(owner + CTOKEN_PROGRAM_ID + mint)
   - Address is the same for all token accounts with same owner and mint
   - Example: `const ata = getAssociatedTokenAddressInterface(mint, owner.publicKey)`

4. **Build Instruction**: Create instruction for token account creation
   - Use `createAtaInterfaceIdempotentInstruction()` (idempotent variant recommended)
   - Pass payer, ATA address, owner, mint, and program ID
   - Idempotent ensures instruction succeeds even if account exists
   - Optional: Pass `compressibleConfig` for custom rent configuration
   - Example:
     ```typescript
     const ix = createAtaInterfaceIdempotentInstruction(
         payer.publicKey,  // Fee payer
         ata,              // Associated token address
         owner.publicKey,  // Owner
         mint,             // Mint address
         CTOKEN_PROGRAM_ID // Program ID
     );
     ```

5. **Send Transaction**: Sign and submit transaction to network
   - Get recent blockhash with `rpc.getLatestBlockhash()`
   - Use `buildAndSignTx()` with compute budget and instruction
   - Set compute unit limit to 30,000 for account creation
   - Use `sendAndConfirmTx()` to submit and wait for confirmation
   - Example:
     ```typescript
     const { blockhash } = await rpc.getLatestBlockhash();
     const tx = buildAndSignTx(
         [ComputeBudgetProgram.setComputeUnitLimit({ units: 30_000 }), ix],
         payer,
         blockhash,
         []
     );
     await sendAndConfirmTx(rpc, tx);
     ```

6. **Verify Account**: Fetch and verify token account data (optional)
   - Use `getAccountInterface()` with RPC and ATA address
   - Verify mint matches expected mint
   - Verify owner matches expected owner
   - Verify initial amount is 0
   - Example:
     ```typescript
     const accountInfo = await getAccountInterface(rpc, ata);
     console.log('Mint:', accountInfo.mint);
     console.log('Owner:', accountInfo.owner);
     console.log('Amount:', accountInfo.amount);
     ```

### Phase 4: Test

Run the client code. On failure, debug and retry. Assign debugging to subagents with Task tool.

For localnet testing:
```bash
light test-validator
```

For devnet/mainnet, ensure RPC endpoint supports ZK Compression (Helius, Triton).

**Expected Output:**
- Transaction signature confirming account creation
- Token account with 0 balance
- Mint and owner matching input parameters

**Common Issues:**
- Missing compute budget: Add `ComputeBudgetProgram.setComputeUnitLimit({ units: 30_000 })`
- Account already exists: Use idempotent instruction variant
- Invalid mint: Ensure mint is a compressed mint (created with `createMintInterface`)

**Code Example:**

```typescript
import {
    createRpc,
    buildAndSignTx,
    sendAndConfirmTx,
    CTOKEN_PROGRAM_ID,
} from '@lightprotocol/stateless.js';
import {
    createMintInterface,
    createAtaInterfaceIdempotent,
    getAssociatedTokenAddressInterface,
    getAccountInterface,
} from '@lightprotocol/compressed-token';
import { ComputeBudgetProgram, Keypair } from '@solana/web3.js';

async function main() {
    // 1. Setup RPC connection
    const rpc = createRpc('https://devnet.helius-rpc.com?api-key=YOUR_API_KEY');
    const payer = Keypair.generate(); // Load your keypair here

    // 2. Create compressed mint (prerequisite)
    const mintAddress = await createMintInterface(
        rpc,
        payer,
        payer.publicKey,  // Mint authority
        9                 // Decimals
    );
    console.log('Mint created:', mintAddress.toBase58());

    // 3. Create token account using high-level action
    const ata = await createAtaInterfaceIdempotent(
        rpc,
        payer,
        mintAddress,
        payer.publicKey  // Owner
    );
    console.log('Token account created:', ata.toBase58());

    // 4. Verify account
    const accountInfo = await getAccountInterface(rpc, ata);
    console.log('Mint:', accountInfo.mint.toBase58());
    console.log('Owner:', accountInfo.owner.toBase58());
    console.log('Amount:', accountInfo.amount);
}

main();
```

**Low-level instruction example:**

```typescript
import {
    createRpc,
    buildAndSignTx,
    sendAndConfirmTx,
    CTOKEN_PROGRAM_ID,
} from '@lightprotocol/stateless.js';
import {
    createAtaInterfaceIdempotentInstruction,
    getAssociatedTokenAddressInterface,
} from '@lightprotocol/compressed-token';
import { ComputeBudgetProgram, Keypair, PublicKey } from '@solana/web3.js';

async function createTokenAccountManual() {
    // Setup
    const rpc = createRpc('https://devnet.helius-rpc.com?api-key=YOUR_API_KEY');
    const payer = Keypair.generate();
    const mint = new PublicKey('YOUR_MINT_ADDRESS');

    // Derive ATA address
    const ata = getAssociatedTokenAddressInterface(
        mint,
        payer.publicKey,
        false,  // allowOwnerOffCurve
        CTOKEN_PROGRAM_ID
    );

    // Build instruction
    const ix = createAtaInterfaceIdempotentInstruction(
        payer.publicKey,
        ata,
        payer.publicKey,
        mint,
        CTOKEN_PROGRAM_ID
    );

    // Send transaction
    const { blockhash } = await rpc.getLatestBlockhash();
    const tx = buildAndSignTx(
        [ComputeBudgetProgram.setComputeUnitLimit({ units: 30_000 }), ix],
        payer,
        blockhash,
        []
    );
    const signature = await sendAndConfirmTx(rpc, tx);

    console.log('Transaction signature:', signature);
    console.log('Token account:', ata.toBase58());
}
```

~~~~
