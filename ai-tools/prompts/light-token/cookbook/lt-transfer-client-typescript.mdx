~~~~text
---
argument-hint: <project_path>
description: Transfer tokens between SPL, Token-2022, and Light Token accounts in TypeScript
allowed-tools: [Bash, Read, Glob, Grep, Task, mcp__deepwiki, mcp__zkcompression]
---

## Task: Transfer tokens between accounts (TypeScript)

References:
- Cookbook Guide: https://zkcompression.com/light-token/cookbook/transfer-interface
- SDK Reference: https://lightprotocol.github.io/light-protocol/compressed-token/index.html
- GitHub Example: https://github.com/Lightprotocol/examples-light-token

MCP:
* deepwiki https://mcp.deepwiki.com/mcp
* zkcompression https://www.zkcompression.com/mcp

## Workflow

- This plan must execute without user intervention
- All questions have been resolved in planning phase
- If blocked, find alternative approach - do not stop
- Keep working until ALL todos are complete
- Use Task tool with subagents for parallel research or when stuck
- Use subagents with Read, Glob, Grep, and Deepwiki permissions when stuck
- Always assign Tasks to subagents and tell the user

## DeepWiki fallback

```
mcp__deepwiki__read_wiki_structure("Lightprotocol/light-protocol"),
mcp__deepwiki__read_wiki_contents("Lightprotocol/light-protocol"),
mcp__deepwiki__ask_question("Lightprotocol/light-protocol", "<question>")
```

## Quick Reference

| Operation | Function | Purpose |
|-----------|----------|---------|
| Connect | createRpc() | Connect to ZK Compression RPC endpoint |
| Transfer (Action) | transferInterface() | High-level transfer between any account types |
| Transfer (Instruction) | createTransferInterfaceInstruction() | Build instruction for manual transaction construction |
| Get ATA Address | getAssociatedTokenAddressInterface() | Derive associated token account address |
| Create ATA | createAtaInterface() | Create associated token account |
| Send Transaction | sendAndConfirmTransaction() | Submit transaction to network |

### Transfer Routes

The transfer interface detects account types and routes automatically:

| From | To | Behavior |
|------|-----|----------|
| Light Token | Light Token | Direct transfer between compressed accounts |
| SPL Token | Light Token | Locks SPL tokens in interface PDA, mints light-tokens |
| Light Token | SPL Token | Burns light-tokens, releases SPL tokens from PDA |

### Phase 1: Index project

```bash
grep -r "transferInterface\|@lightprotocol/compressed-token\|@solana/web3.js" src/
```

### Phase 2: Add dependencies

```bash
npm install --save \
    @lightprotocol/compressed-token@0.22.1-alpha.1 \
    @lightprotocol/stateless.js@0.22.1-alpha.1 \
    @solana/web3.js
```

### Phase 3: Implement transfer

See Code Reference below for TypeScript implementation.

**Two Approaches:**

1. **Action (Recommended)**: Use `transferInterface()` for simple, automatic transfers
   - Automatically detects source and destination account types
   - Routes to correct program (SPL, Token-2022, or Light Token)
   - Returns transaction signature
   - Example: Action code below

2. **Instruction (Advanced)**: Use `createTransferInterfaceInstruction()` for manual transaction control
   - Gives full control over transaction construction
   - Useful for batching multiple instructions
   - Example: Instruction code below

#### Action Approach

1. **RPC Setup**: Connect to ZK Compression RPC endpoint (Helius, Triton, or localnet)
   - Use `createRpc()` with mainnet, devnet, or local URLs
   - For devnet: `https://devnet.helius-rpc.com?api-key=${API_KEY}`
   - For localnet: `createRpc()` with no arguments

2. **Transfer Tokens**: Call `transferInterface()` with parameters
   - Parameters: `(rpc, payer, source, mint, destination, authority, amount, options?)`
   - `source` - Source token account (SPL, Token-2022, or Light)
   - `destination` - Destination token account (SPL, Token-2022, or Light)
   - `authority` - Account with authority over source account (must be `Signer`)
   - `amount` - Number of tokens to transfer (in smallest units)
   - `mint` - Mint address (required for interface detection)
   - Returns transaction signature

#### Instruction Approach

1. **RPC Setup**: Same as Action approach

2. **Build Instruction**: Create transfer instruction with parameters
   - Call `createTransferInterfaceInstruction(source, destination, authority, amount, options?)`
   - `source` - Source token account address
   - `destination` - Destination token account address
   - `authority` - Authority public key
   - `amount` - Number of tokens to transfer
   - Returns instruction for transaction

3. **Build Transaction**: Create transaction with compute budget and instruction
   - Create `Transaction()` and add compute budget instruction
   - Add transfer instruction to transaction
   - Sign with payer and authority (if different)

4. **Send Transaction**: Submit to network
   - Use `sendAndConfirmTransaction(rpc, tx, signers)`
   - Include all required signers (payer + authority)

### Phase 4: Test

Run the client code. On failure, debug and retry. Assign debugging to subagents with Task tool.

For localnet testing:
```bash
light test-validator
```

For devnet/mainnet, ensure RPC endpoint supports ZK Compression (Helius, Triton).

## Code Reference

### Action Approach (Recommended)

```typescript
import "dotenv/config";
import { Keypair } from "@solana/web3.js";
import { createRpc } from "@lightprotocol/stateless.js";
import {
    createMintInterface,
    createAtaInterface,
    mintToInterface,
    transferInterface,
    getAssociatedTokenAddressInterface,
} from "@lightprotocol/compressed-token";
import { homedir } from "os";
import { readFileSync } from "fs";

// devnet:
const RPC_URL = `https://devnet.helius-rpc.com?api-key=${process.env.API_KEY!}`;
// localnet:
// const RPC_URL = undefined;
const payer = Keypair.fromSecretKey(
    new Uint8Array(
        JSON.parse(readFileSync(`${homedir()}/.config/solana/id.json`, "utf8"))
    )
);

(async function () {
    // devnet:
    const rpc = createRpc(RPC_URL);
    // localnet:
    // const rpc = createRpc();

    // Create mint for testing
    const { mint } = await createMintInterface(rpc, payer, payer, null, 9);

    // Create sender account and mint tokens
    const sender = Keypair.generate();
    await createAtaInterface(rpc, payer, mint, sender.publicKey);
    const senderAta = getAssociatedTokenAddressInterface(mint, sender.publicKey);
    await mintToInterface(rpc, payer, mint, senderAta, payer, 1_000_000_000);

    // Create recipient account
    const recipient = Keypair.generate();
    await createAtaInterface(rpc, payer, mint, recipient.publicKey);
    const recipientAta = getAssociatedTokenAddressInterface(mint, recipient.publicKey);

    // Transfer tokens
    const tx = await transferInterface(
        rpc,
        payer,
        senderAta,
        mint,
        recipientAta,
        sender,
        500_000_000
    );

    console.log("Tx:", tx);
})();
```

### Instruction Approach (Advanced)

```typescript
import "dotenv/config";
import {
    Keypair,
    ComputeBudgetProgram,
    Transaction,
    sendAndConfirmTransaction,
} from "@solana/web3.js";
import { createRpc } from "@lightprotocol/stateless.js";
import {
    createMintInterface,
    createAtaInterface,
    mintToInterface,
    createTransferInterfaceInstruction,
    getAssociatedTokenAddressInterface,
} from "@lightprotocol/compressed-token";
import { homedir } from "os";
import { readFileSync } from "fs";

// devnet:
const RPC_URL = `https://devnet.helius-rpc.com?api-key=${process.env.API_KEY!}`;
const rpc = createRpc(RPC_URL);
// localnet:
// const rpc = createRpc();

const payer = Keypair.fromSecretKey(
    new Uint8Array(
        JSON.parse(readFileSync(`${homedir()}/.config/solana/id.json`, "utf8"))
    )
);

(async function () {
    // Create mint for testing
    const { mint } = await createMintInterface(rpc, payer, payer, null, 9);

    // Create sender account and mint tokens
    const sender = Keypair.generate();
    await createAtaInterface(rpc, payer, mint, sender.publicKey);
    const senderAta = getAssociatedTokenAddressInterface(
        mint,
        sender.publicKey
    );
    await mintToInterface(rpc, payer, mint, senderAta, payer, 1_000_000_000);

    // Create recipient account
    const recipient = Keypair.generate();
    await createAtaInterface(rpc, payer, mint, recipient.publicKey);
    const recipientAta = getAssociatedTokenAddressInterface(
        mint,
        recipient.publicKey
    );

    // Build transfer instruction
    const ix = createTransferInterfaceInstruction(
        senderAta,
        recipientAta,
        sender.publicKey,
        500_000_000
    );

    // Build and send transaction
    const tx = new Transaction().add(ix);
    const signature = await sendAndConfirmTransaction(rpc, tx, [payer, sender]);

    console.log("Tx:", signature);
})();
```

### Key Differences

| Aspect | Action Approach | Instruction Approach |
|--------|----------------|---------------------|
| Complexity | Simple, one function call | More setup required |
| Control | Automatic | Full manual control |
| Use Case | Most common scenarios | Batching, custom flows |
| Account Detection | Automatic | Automatic |
| Transaction | Auto-built and sent | Must build and send |

### Transfer Types

#### Light Token to Light Token

Both source and destination are light-token accounts. Direct transfer between compressed accounts.

```typescript
// Both accounts must be light-token accounts
const tx = await transferInterface(
    rpc,
    payer,
    lightSourceAta,      // light-token account
    mint,
    lightDestinationAta, // light-token account
    authority,
    amount
);
```

#### SPL Token to Light Token

Source is SPL token account, destination is light-token account. SPL tokens are locked in interface PDA, light-tokens are minted.

```typescript
// Source is SPL, destination is light-token
const tx = await transferInterface(
    rpc,
    payer,
    splSourceAta,        // SPL token account
    mint,
    lightDestinationAta, // light-token account
    authority,
    amount
);
```

#### Light Token to SPL Token

Source is light-token account, destination is SPL token account. Light-tokens are burned, SPL tokens are released from PDA.

```typescript
// Source is light-token, destination is SPL
const tx = await transferInterface(
    rpc,
    payer,
    lightSourceAta,      // light-token account
    mint,
    splDestinationAta,   // SPL token account
    authority,
    amount
);
```

### Important Notes

1. **Automatic Routing**: The interface automatically detects account types and routes to the correct program

2. **SPL Interface PDA**: For SPL â†” light-token transfers, the interface uses a PDA to lock/unlock SPL tokens

3. **Authority Requirement**: The authority must be a `Signer` with permission to transfer from the source account

4. **Network Selection**:
   - Devnet: Use Helius RPC with API key
   - Localnet: Use `createRpc()` with no arguments (requires `light test-validator`)

5. **Account Creation**: Use `createAtaInterface()` to create associated token accounts before transferring

~~~~
