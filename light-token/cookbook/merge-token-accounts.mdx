---
title: Merge Token Accounts
sidebarTitle: Merge Accounts
description: Consolidate multiple compressed token accounts into fewer accounts
---

import CTokenTsClientPrerequisites from '/snippets/light-token-guides/light-token-ts-client-prerequisites.mdx';

Merge consolidates multiple compressed token accounts (cold storage) into fewer accounts, reducing account fragmentation.

<Info>
Find the source code [here](https://github.com/Lightprotocol/light-protocol/blob/main/js/compressed-token/tests/e2e/merge-token-accounts.test.ts).
</Info>

<Note>
Merging reduces the number of accounts to query and proofs needed for transfers. Useful after receiving many small token amounts.
</Note>

## Prerequisites

<CTokenTsClientPrerequisites />

## Usage

```typescript
import { Keypair } from '@solana/web3.js';
import { createRpc, bn } from '@lightprotocol/stateless.js';
import {
    createMint,
    mintTo,
    mergeTokenAccounts,
} from '@lightprotocol/compressed-token';

async function main() {
    const rpc = createRpc();
    const payer = Keypair.generate();
    await rpc.requestAirdrop(payer.publicKey, 1e9);

    const owner = Keypair.generate();
    await rpc.requestAirdrop(owner.publicKey, 1e9);

    const mintAuthority = Keypair.generate();
    const mintKeypair = Keypair.generate();

    // 1. Create mint
    const { mint } = await createMint(
        rpc,
        payer,
        mintAuthority.publicKey,
        9,
        mintKeypair,
    );

    // 2. Mint multiple times to create multiple compressed accounts
    for (let i = 0; i < 5; i++) {
        await mintTo(rpc, payer, mint, owner.publicKey, mintAuthority, bn(100));
    }

    // 3. Check accounts before merge
    const accountsBefore = await rpc.getCompressedTokenAccountsByOwner(
        owner.publicKey,
        { mint },
    );
    console.log('Accounts before merge:', accountsBefore.items.length);

    // 4. Merge token accounts
    const signature = await mergeTokenAccounts(
        rpc,
        payer,
        mint,
        owner,  // owner (signer)
    );

    console.log('Merged token accounts');
    console.log('Transaction:', signature);

    // 5. Check accounts after merge
    const accountsAfter = await rpc.getCompressedTokenAccountsByOwner(
        owner.publicKey,
        { mint },
    );
    console.log('Accounts after merge:', accountsAfter.items.length);

    // Verify total balance unchanged
    const totalBefore = accountsBefore.items.reduce(
        (sum, acc) => sum.add(acc.parsed.amount),
        bn(0),
    );
    const totalAfter = accountsAfter.items.reduce(
        (sum, acc) => sum.add(acc.parsed.amount),
        bn(0),
    );
    console.log('Total balance:', totalAfter.toString(), '(unchanged)');
}

main().catch(console.error);
```
